
# nginx 转发大数据过被截断
> 超过 32k 的 json 数据被截断，导致前端解析错误

## 问题解析
检查后发现是 Nginx 的代理缓冲 proxy_buffering 将过一些数据缓存在硬盘中，而却没有权限读取，所以截断了

## 解决
### 1. 关闭代理缓存 off

```
// 不缓存某个端口的请求
server {
    listen 80;
        ...
        proxy_buffering off;
        ...
}

// 或者不缓存某个请求

server {
    listen 80;
        ...
    location /api/ {
        proxy_buffering off;
    }
    
}
```

但关闭代理缓存，会因为客户端到 nginx 的网速过慢，导致 nginx 只能以一个较慢的速度将响应传给客户端；进而导致后端 server 也只能以同样较慢的速度传递响应给 nginx，造成一次请求连接耗时过长。而缓存开启后就可以较快的速度接受 serve 的数据，然后在根据客户端请求速度返回给客户端，减少了请求时间

### 3. 设置存储内存 buffer 的大小

```
server {
    listen 80;
        proxy_buffering on;
        proxy_buffers  8  4k;
        ...
}
这个参数设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小。
所有buffer的大小为这两个数字的乘积。
```

这个设置过大时，这里设置的缓冲区大小是针对每个请求连接而言的。也就是说对于每一个连接，都会分配 ”number*size“大小的内存缓冲区。导致 nginx 会占用大量内存，从而减少并发数量。

### 3. 将缓存目录文件读取权限赋予 nginx
> proxy_buffering 开启的情况下，nignx会把后端返回的内容先放到缓冲区当中，然后再返回给客户端(边收边传，不是全部接收完再传给客户端)。 如果响应内容无法放在内存里边,那么部分内容会被写到磁盘上。

##### 提升 nginx 配置文件权限为 root


```
user root;
```

##### 配置缓存目录的权限可以被 nginx 读取

1. 指定所有用户

```
chmod 777 缓存目录路径
// 让所有用户都可读可写可执行缓存目录，慎用。
```

2. 指定特定用户

```
#修改文件|目录的拥有者
chown 用户名 目录名|文件名

#递归修改文件|目录的组
chgrp -R 组名 文件名|目录名

#递归修改文件权限
chmod -R 755 文件名|目录名
```